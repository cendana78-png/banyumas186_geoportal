<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Desa Pekunden - Zoom Optimized</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" /> 

    <style>
        :root { --color-primary: #1f2223; --color-secondary: #ffc107; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; display: flex; flex-direction: column; }
        .map-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        #map { flex-grow: 1; height: 100%; } 
        .main-header { background-color: var(--color-primary); color: white; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2000; }
        .header-left { display: flex; align-items: center; }
        .header-left img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; }
        .logo-text { font-size: 20px; font-weight: bold; }
        nav { display: flex; }
        nav a { color: white; text-decoration: none; padding: 0 15px; font-size: 15px; }
        .menu-toggle { background: none; border: none; color: white; font-size: 24px; cursor: pointer; display: none; }
        .page-title { background-color: #f4f4f4; padding: 10px; text-align: center; font-size: 20px; color: var(--color-primary); border-bottom: 2px solid #ddd; font-weight: bold; }
        footer { background-color: var(--color-primary); color: white; text-align: center; padding: 8px; font-size: 11px; }

        /* Label Styling */
        .custom-permanent-label {
            background: transparent !important; border: none !important; box-shadow: none !important;
            font-weight: bold; font-size: 11px; color: #ffc107; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9); pointer-events: none; opacity: 0;
        }

        /* Legenda / Layer Control */
        .leaflet-control-layers-expanded { padding: 10px !important; background: rgba(255, 255, 255, 0.95) !important; width: 230px; }
        .leg-item { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: #333; }
        .leg-box { width: 14px; height: 14px; border: 1px solid #333; display: inline-block; }
        .leg-line { width: 20px; height: 3px; display: inline-block; }
        .leg-dash { width: 20px; border-top: 2px dashed; display: inline-block; vertical-align: middle; }

        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            nav { display: none; position: absolute; top: 100%; right: 0; width: 200px; background: var(--color-primary); flex-direction: column; }
            nav.active { display: flex; }
        }
    </style>
</head>
<body>
    <div class="main-header">
        <div class="header-left">
            <img src="Banyumas.png" alt="Logo">
            <span class="logo-text">Geoportal Pekunden</span>
        </div>
        <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <nav id="main-nav">
            <a href="index.html">Beranda</a>
            <a href="peta_kecamatan.html">Peta Banyumas</a>
            <a href="peta_desa.html" style="font-weight:bold;">Peta Pekunden</a>
            <a href="tentang.html">Tentang</a>
        </nav>
    </div>

    <div class="page-title">Peta Administratif & Infrastruktur Desa</div>
    <div class="map-container"><div id="map"></div></div>
    <footer>&copy; 2025 Geoportal Desa Pekunden</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script> 

    <script>
    function toggleMenu() { document.getElementById('main-nav').classList.toggle('active'); }

    var map = L.map('map', { zoomControl: false }).setView([-7.51, 109.28], 15);
    const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Satellite'
    }).addTo(map);

    let overlayLayers = {};
    let layerPromises = [];
    let boundaryLayer = null;

    // Wadah untuk manajemen visibilitas otomatis
    let tierGroups = {
        1: [], // Selalu muncul (Batas Desa)
        2: [], // Muncul di Zoom >= 14 (Jalan Kec, RW, RT)
        3: []  // Muncul di Zoom >= 16 (Jalan Desa, POI, Sawah, Sungai)
    };

    function onEachFeature(feature, layer) {
        if (feature.properties) {
            let txt = feature.properties.NAMA || feature.properties.Jenis || feature.properties.name || "";
            if (feature.properties.RT || feature.properties.RW) {
                txt = `RT ${feature.properties.RT || feature.properties.NO_RT} / RW ${feature.properties.RW || feature.properties.NO_RW}`;
            }
            if (txt) layer.bindTooltip(txt, { permanent: true, className: 'custom-permanent-label', direction: 'center' });
        }
    }

    function addLayer(file, name, style, type, symbolHtml, tier) {
        const promise = fetch(file).then(res => res.json()).then(data => {
            const lyr = L.geoJSON(data, {
                style: style,
                onEachFeature: onEachFeature,
                pointToLayer: type === 'point' ? (f, ll) => L.marker(ll, {
                    icon: L.divIcon({ className: 'custom-poi', html: symbolHtml })
                }) : null
            });

            // Simpan ke tier
            tierGroups[tier].push(lyr);
            
            if (name === 'Batas Desa Pekunden') boundaryLayer = lyr;

            const menuLabel = `<span class="leg-item">${symbolHtml} ${name}</span>`;
            overlayLayers[menuLabel] = lyr;
            return lyr;
        }).catch(err => console.log("Gagal muat:", file));
        layerPromises.push(promise);
    }

    // --- DEKLARASI LAYER DENGAN TIER ---

    // TIER 1: SELALU TERLIHAT
    addLayer('batas_desa_pekunden.geojson', 'Batas Desa Pekunden', { color: 'red', weight: 4, dashArray: '5,5', fillOpacity: 0.1 }, 'poly', '<span class="leg-dash" style="border-color:red"></span>', 1);

    // TIER 2: ZOOM >= 14
    addLayer('jl_kecamatan.geojson', 'Jalan Kecamatan', { color: 'gray', weight: 4 }, 'line', '<span class="leg-line" style="background:gray"></span>', 2);
    addLayer('rw.geojson', 'Batas RW', { color: '#C71585', weight: 2.5, dashArray: '10,5', fillOpacity: 0.1 }, 'poly', '<span class="leg-dash" style="border-color:#C71585"></span>', 2);
    addLayer('rt.geojson', 'Batas RT', { color: 'purple', weight: 1.5, fillOpacity: 0.1 }, 'poly', '<span class="leg-line" style="background:purple; height:1px; margin-top:8px"></span>', 2);

    // TIER 3: ZOOM >= 16
    addLayer('jl_desa.geojson', 'Jalan Desa', { color: 'black', weight: 3 }, 'line', '<span class="leg-line" style="background:black"></span>', 3);
    addLayer('jl_sungai.geojson', 'Jalan Sungai', { color: 'blue', weight: 2 }, 'line', '<span class="leg-line" style="background:blue"></span>', 3);
    addLayer('sawah.geojson', 'Sawah', { color: '#556B2F', fillOpacity: 0.6, weight: 1 }, 'poly', '<span class="leg-box" style="background:#556B2F"></span>', 3);
    addLayer('kebun.geojson', 'Kebun', { color: '#8FBC8F', fillOpacity: 0.5, weight: 1 }, 'poly', '<span class="leg-box" style="background:#8FBC8F"></span>', 3);
    
    // POI (Tier 3)
    addLayer('balai_desa.geojson', 'Balai Desa', {}, 'point', '<i class="fas fa-landmark" style="color:blue"></i>', 3);
    addLayer('sekolah.geojson', 'Sekolah', {}, 'point', '<i class="fas fa-school" style="color:orange"></i>', 3);
    addLayer('tempat_ibadah.geojson', 'Tempat Ibadah', {}, 'point', '<i class="fas fa-mosque" style="color:purple"></i>', 3);
    addLayer('kesehatan.geojson', 'Kesehatan', {}, 'point', '<i class="fas fa-medkit" style="color:red"></i>', 3);
    addLayer('fasilitas_umum.geojson', 'Fasilitas Umum', {}, 'point', '<i class="fas fa-city" style="color:darkcyan"></i>', 3);

    // MANAJEMEN VISIBILITAS OTOMATIS
    function updateVisibility() {
        const zoom = map.getZoom();
        
        // Aturan Tier 1 (Selalu)
        tierGroups[1].forEach(lyr => { if (!map.hasLayer(lyr)) lyr.addTo(map); });

        // Aturan Tier 2 (Zoom 14 ke atas)
        tierGroups[2].forEach(lyr => {
            if (zoom >= 14) { if (!map.hasLayer(lyr)) lyr.addTo(map); } 
            else { if (map.hasLayer(lyr)) map.removeLayer(lyr); }
        });

        // Aturan Tier 3 (Zoom 16 ke atas)
        tierGroups[3].forEach(lyr => {
            if (zoom >= 16) { if (!map.hasLayer(lyr)) lyr.addTo(map); } 
            else { if (map.hasLayer(lyr)) map.removeLayer(lyr); }
        });

        // Update Opasitas Tooltip (Label)
        document.querySelectorAll('.custom-permanent-label').forEach(el => {
            el.style.opacity = (zoom >= 16) ? "1" : (zoom >= 14 ? "0.7" : "0");
        });
    }

    Promise.all(layerPromises).then(() => {
        L.control.layers(null, overlayLayers, { collapsed: true, position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.locate({ position: 'topleft', flyTo: true }).addTo(map);

        if (boundaryLayer) map.fitBounds(boundaryLayer.getBounds());

        // Jalankan saat zoom berubah dan saat pertama kali load
        map.on('zoomend', updateVisibility);
        updateVisibility();
    });
    </script>
</body>
</html>
