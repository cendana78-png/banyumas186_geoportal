<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Administratif Kecamatan Banyumas</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" /> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" /> 

    <style>
        :root { 
            --color-primary: #1f2223; 
            --color-secondary: #ffc107; 
        }
        body, html { 
            margin: 0; padding: 0; height: 100%; min-height: 100vh; 
            font-family: Arial, sans-serif; display: flex; flex-direction: column; 
        }
        .map-container { flex: 1; display: flex; flex-direction: column; }
        #map { flex-grow: 1; height: 100%; } 
        
        .main-header { 
            background-color: var(--color-primary); color: white; padding: 10px 5%; 
            display: flex; justify-content: space-between; align-items: center; 
            position: relative; z-index: 2000;
        }
        .header-left { display: flex; align-items: center; }
        .header-left img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; }
        .logo-text { font-size: 24px; font-weight: bold; }
        
        nav { display: flex; } 
        nav a { color: white; text-decoration: none; padding: 0 15px; font-size: 16px; }
        
        .menu-toggle {
            background: none; border: none; color: white; font-size: 24px;
            cursor: pointer; display: none; 
        }

        .page-title { background-color: #f4f4f4; padding: 15px; text-align: center; font-size: 24px; color: var(--color-primary); border-bottom: 2px solid #ddd; }
        footer { background-color: var(--color-primary); color: white; text-align: center; padding: 10px; font-size: 12px; }

        .custom-permanent-label {
            background: transparent !important; border: none !important; box-shadow: none !important;
            font-weight: bold; font-size: 12px; color: var(--color-secondary); 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9); white-space: nowrap;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; 
        }

        .leaflet-marker-icon.balai-desa-icon i { font-size: 28px; color: blue; text-shadow: 2px 2px 3px rgba(0,0,0,0.5); }
        
        /* Styling Legenda */
        .leaflet-control-layers-overlays label { display: flex !important; align-items: center !important; gap: 8px; margin-bottom: 2px; }
        .legend-icon { display: inline-flex; width: 20px; justify-content: center; align-items: center; }
        .box-color { width: 15px; height: 15px; border: 1px solid #333; display: inline-block; }
        .line-dashed { width: 20px; height: 0px; border-top: 3px dashed black; display: inline-block; }

        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            nav {
                display: none; position: absolute; top: 100%; right: 0;
                width: 70%; max-width: 250px; background-color: var(--color-primary);
                flex-direction: column; z-index: 1000;
            }
            nav.active { display: flex; }
            nav a { padding: 12px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        }
    </style>
</head>
<body>
    <div class="main-header">
        <div class="header-left">
            <img src="Banyumas.png" alt="Logo">
            <span class="logo-text">Geoportal Banyumas</span>
        </div>
        <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <nav id="main-nav">
            <a href="index.html"><i class="fas fa-home"></i> Beranda</a>
            <a href="peta_kecamatan.html" style="font-weight: bold;"><i class="fas fa-map"></i> Peta Banyumas</a>
            <a href="peta_desa.html"><i class="fas fa-map-marked-alt"></i> Peta Pekunden</a>
            <a href="tentang.html"><i class="fas fa-info-circle"></i> Tentang</a>
        </nav>
    </div>

    <div class="page-title">Peta Administratif Kecamatan Banyumas</div>
    <div class="map-container"><div id="map"></div></div>
    <footer><p>&copy; 2025 Geoportal Banyumas. Peta Kecamatan.</p></footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script> 
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> 

    <script>
    function toggleMenu() { document.getElementById('main-nav').classList.toggle('active'); }

    var map = L.map('map', { zoomControl: false }).setView([-7.525, 109.30], 13); 

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' });
    const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Satellite'
    }).addTo(map);

    let labeledLayers = []; 
    let overlayLayers = {};
    let layerPromises = []; 
    let boundaryLayer = null; 

    // Objek manajemen Tier Rendering
    let tierGroups = {
        kecamatan: [], // Selalu muncul
        desa: [],      // Zoom >= 12
        poi: []        // Zoom >= 14
    };

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
        return color;
    }

    function onEachFeature(feature, layer) {
        if (feature.properties) {
            let popupContent = "<table>";
            let labelText = feature.properties.NAMA_DESA || feature.properties.NAMA || layer.options.layerName || "";
            let isAreaLayer = (layer.options.layerName !== 'Balai Desa' && layer.options.layerName !== 'Kecamatan Banyumas');

            for (let key in feature.properties) {
                if (feature.properties[key] && !['fid', 'id', 'Id', 'layer'].includes(key.toLowerCase())) { 
                    let labelKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    popupContent += `<tr><td><b>${labelKey}:</b></td><td>${feature.properties[key]}</td></tr>`;
                }
            }
            layer.bindPopup(popupContent + "</table>");

            if (labelText) {
                layer.bindTooltip(labelText, {
                    permanent: true, direction: isAreaLayer ? 'center' : 'auto', 
                    className: 'custom-permanent-label'
                });
                labeledLayers.push({ layer: layer, isArea: isAreaLayer });
            }
        }
    }

    // Fungsi load dimodifikasi untuk mendukung Tiering
    function loadGeoJSONLayer(fileName, layerName, styleOptions, pointToLayerFunc, tier, legendIconHtml = "") {
        const promise = fetch(fileName)
            .then(res => res.json())
            .then(data => {
                const lyr = L.geoJSON(data, {
                    style: styleOptions,
                    pointToLayer: pointToLayerFunc,
                    onEachFeature: onEachFeature,
                    layerName: layerName
                });

                // Klasifikasi ke dalam Tier
                if (tier === 'kecamatan') {
                    tierGroups.kecamatan.push(lyr);
                    boundaryLayer = lyr;
                } else if (tier === 'desa') {
                    tierGroups.desa.push(lyr);
                } else if (tier === 'poi') {
                    tierGroups.poi.push(lyr);
                }

                const labelWithIcon = `<span class="legend-icon">${legendIconHtml}</span> ${layerName}`;
                overlayLayers[labelWithIcon] = lyr;
                return lyr;
            }).catch(err => console.error(`Gagal: ${fileName}`, err));
        layerPromises.push(promise);
    }

    // --- PEMUATAN DATA ---
    const namaDesa = ["Pekunden", "kedunguter", "sudagaran", "papringan", "kalisube", "Binangun", "Karangrau", "Danaraja", "Dawuhan", "pasinggangan", "Kejawar", "kedunggede"];
    namaDesa.forEach(desa => {
        const color = getRandomColor();
        const icon = `<span class="box-color" style="background-color:${color}; opacity:0.5;"></span>`;
        loadGeoJSONLayer(`${desa.toLowerCase()}.geojson`, desa, { color: color, weight: 2, fillOpacity: 0.3 }, null, 'desa', icon);
    });

    const kecIcon = `<span class="line-dashed"></span>`;
    loadGeoJSONLayer('kecamatan_banyumas.geojson', 'Kecamatan Banyumas', { color: 'black', weight: 5, fillOpacity: 0, dashArray: '10, 5' }, null, 'kecamatan', kecIcon);

    const balaiIcon = `<i class="fas fa-landmark" style="color: blue; font-size: 12px;"></i>`;
    const balaiMarker = (f, ll) => L.marker(ll, { 
        icon: L.divIcon({ className: 'balai-desa-icon', html: `<i class="fas fa-landmark" style="color: blue;"></i>` }) 
    });
    loadGeoJSONLayer('balai_desaa.geojson', 'Balai Desa', {}, balaiMarker, 'poi', balaiIcon);

    // --- FUNGSI RENDERING OTOMATIS ---
    function updateVisibility() {
        const zoom = map.getZoom();

        // Tier 1: Kecamatan (Selalu Ada)
        tierGroups.kecamatan.forEach(l => { if (!map.hasLayer(l)) l.addTo(map); });

        // Tier 2: Desa (Zoom >= 12)
        tierGroups.desa.forEach(l => {
            if (zoom >= 12) { if (!map.hasLayer(l)) l.addTo(map); } 
            else { if (map.hasLayer(l)) map.removeLayer(l); }
        });

        // Tier 3: Balai Desa (Zoom >= 14)
        tierGroups.poi.forEach(l => {
            if (zoom >= 14) { if (!map.hasLayer(l)) l.addTo(map); } 
            else { if (map.hasLayer(l)) map.removeLayer(l); }
        });

        // Kontrol Label
        labeledLayers.forEach(item => {
            const el = item.layer.getTooltip() ? item.layer.getTooltip().getElement() : null;
            if (el) {
                let opacity = 0;
                if (item.isArea && zoom >= 12) opacity = 0.9;
                if (!item.isArea && zoom >= 14) opacity = 0.8;
                el.style.opacity = opacity;
            }
        });
    }

    Promise.all(layerPromises).then(() => {
        L.control.layers({ "Satelit": satellite, "Peta": osm }, overlayLayers, { collapsed: false, position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.locate({ strings: { title: "Lokasi Saya" }, position: 'topleft', flyTo: true }).addTo(map);
        
        const allFeatures = L.featureGroup(Object.values(overlayLayers));
        L.control.search({
            layer: allFeatures, propertyName: 'NAMA_DESA', initial: false, zoom: 15,
            marker: { icon: L.divIcon({ className: 'search-marker-icon', html: '<i class="fas fa-map-marker-alt" style="color: red; font-size: 30px;"></i>' }) },
            textPlaceholder: 'Cari Nama Desa...', position: 'topleft' 
        }).addTo(map);

        L.Control.geocoder({ position: 'topleft', geocoders: [L.Control.Geocoder.nominatim({})] }).addTo(map);
        
        if (boundaryLayer) map.fitBounds(boundaryLayer.getBounds());

        map.on('zoomend', updateVisibility);
        updateVisibility(); 
    });
    </script>
</body>
</html>
