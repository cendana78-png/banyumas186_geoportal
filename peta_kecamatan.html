<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Administratif Kecamatan Banyumas</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" /> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" /> 

    <style>
        :root { 
            --color-primary: #1f2223; 
            --color-secondary: #ffc107; 
            --color-text-dark: #333;
        }
        body, html { 
            margin: 0; padding: 0; height: 100%; min-height: 100vh; 
            font-family: Arial, sans-serif; display: flex; flex-direction: column; 
        }
        
        /* HEADER UTAMA */
        .main-header { 
            background-color: var(--color-primary); 
            color: white; 
            padding: 10px 5%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative; 
            z-index: 3000; /* Ditingkatkan agar di atas peta */
        }
        .header-left { display: flex; align-items: center; }
        .header-left img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; }
        .logo-text { font-size: 24px; font-weight: bold; }
        
        /* NAVIGASI DESKTOP */
        nav { display: flex; align-items: center; } 
        nav a { color: white; text-decoration: none; padding: 0 15px; font-size: 16px; }
        
        .menu-toggle {
            background: none; border: none; color: white; font-size: 24px;
            cursor: pointer; display: none; 
        }

        /* DROPDOWN FIX */
        .nav-dropdown { position: relative; display: inline-block; }
        .nav-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            max-height: 300px; /* Batasi tinggi jika desa banyak */
            overflow-y: auto;  /* Tambahkan scroll jika melebihi max-height */
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 3100;
            border-radius: 4px;
            top: 100%;
            right: 0; /* Align ke kanan agar tidak keluar layar */
        }
        .nav-dropdown-content a {
            color: var(--color-text-dark) !important;
            padding: 12px 16px !important;
            display: block !important;
            border-bottom: 1px solid #eee;
        }
        .nav-dropdown-content a:hover { background-color: #f1f1f1; }
        .nav-dropdown:hover .nav-dropdown-content { display: block; }

        /* PETA & KONTEN */
        .page-title { background-color: #f4f4f4; padding: 10px; text-align: center; font-size: 20px; color: var(--color-primary); border-bottom: 2px solid #ddd; }
        .map-container { flex: 1; position: relative; z-index: 1; }
        #map { height: 100%; width: 100%; } 
        footer { background-color: var(--color-primary); color: white; text-align: center; padding: 10px; font-size: 12px; }

        /* RESPONSIVE HP */
        @media (max-width: 768px) {
            .logo-text { font-size: 18px; }
            .menu-toggle { display: block; }
            nav {
                display: none; 
                position: absolute; 
                top: 100%; 
                left: 0;
                width: 100%; 
                background-color: var(--color-primary);
                flex-direction: column; 
                z-index: 2900;
            }
            nav.active { display: flex; }
            nav a { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; box-sizing: border-box; }
            
            /* Dropdown di HP */
            .nav-dropdown { width: 100%; }
            .nav-dropdown-content { 
                position: static; 
                width: 100%; 
                box-shadow: none; 
                background-color: #2c3e50; 
            }
            .nav-dropdown-content a { color: white !important; padding-left: 30px !important; }
        }

        /* Label Peta */
        .custom-permanent-label {
            background: transparent !important; border: none !important; box-shadow: none !important;
            font-weight: bold; font-size: 12px; color: var(--color-secondary); 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9); pointer-events: none; 
        }
        
        /* --- TAMBAHKAN KODE INI --- */
.leaflet-control-layers-overlays label {
    display: flex !important;
    align-items: center !important;
    gap: 8px; /* Jarak antara kotak warna dan nama desa */
    margin-bottom: 4px;
    cursor: pointer;
}

.legend-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
}

/* Kotak warna untuk setiap desa */
.box-color {
    width: 16px;
    height: 16px;
    border: 1px solid rgba(0,0,0,0.3); /* Garis tepi tipis agar warna muda terlihat */
    display: inline-block;
    border-radius: 3px;
}

/* Garis putus-putus untuk batas kecamatan */
.line-dashed {
    width: 20px;
    height: 0px;
    border-top: 3px dashed red;
    display: inline-block;
}

/* Efek saat kursor menyentuh area */
/* Efek saat kursor menyentuh area */
.leaflet-interactive:hover {
    filter: brightness(1.2); /* Membuat warna sedikit lebih terang */
    stroke: rgb(243, 243, 236);          /* Properti yang benar untuk warna garis tepi */
    stroke-width: 4px;       /* Properti yang benar untuk ketebalan garis */
    transition: all 0.3s;
}

/* Animasi Kelap Kelip */
@keyframes pulse-white {
    0% { fill-opacity: 0.3; stroke-opacity: 1; }
    50% { fill-opacity: 0.9; stroke-opacity: 0.5; }
    100% { fill-opacity: 0.3; stroke-opacity: 1; }
}

.flash-animation {
    animation: pulse-white 0.5s infinite; /* Kecepatan kelap-kelip */
    stroke: white !important;
    stroke-width: 5px !important;
}
    </style>
</head>
<body>
    <div class="main-header">
        <div class="header-left">
            <img src="Banyumas.png" alt="Logo">
            <span class="logo-text">Geoportal Banyumas</span>
        </div>
        <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
        <nav id="main-nav">
            <a href="index.html"><i class="fas fa-home"></i> Beranda</a>
            <a href="peta_kecamatan.html"><i class="fas fa-map"></i> Peta Banyumas</a>
            
            <div class="nav-dropdown">
                <a href="#"><i class="fas fa-map-marked-alt"></i> Peta Desa <i class="fas fa-caret-down"></i></a>
                <div class="nav-dropdown-content">
                    <a href="desa_binangun.html">Binangun</a>
                    <a href="desa_danaraja.html">Danaraja</a>
                    <a href="desa_dawuhan.html">Dawuhan</a>
                    <a href="desa_kalisube.html">Kalisube</a>
                    <a href="desa_karangrau.html">Karangrau</a>
                    <a href="desa_kedunggede.html">Kedunggede</a>
                    <a href="desa_kedunguter.html">Kedunguter</a>
                    <a href="desa_kejawar.html">Kejawar</a>
                    <a href="desa_papringan.html">Papringan</a>
                    <a href="desa_pasinggangan.html">Pasinggangan</a>
                    <a href="desa_pekunden.html">Pekunden</a>
                    <a href="desa_sudagaran.html">Sudagaran</a>
                </div>
            </div>

            <a href="tentang.html"><i class="fas fa-info-circle"></i> Tentang</a>
        </nav>
    </div>

    <div class="page-title">Peta Administratif Kecamatan Banyumas</div>
    <div class="map-container"><div id="map"></div></div>
    <footer><p>&copy; 2025 Geoportal Banyumas. Peta Kecamatan.</p></footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script> 
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> 

    <script>
    // Fungsi menu HP
    function toggleMenu() { 
        document.getElementById('main-nav').classList.toggle('active'); 
    }

    // Inisialisasi Peta
    var map = L.map('map', { zoomControl: false }).setView([-7.525, 109.30], 13); 

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' });
    const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Satellite'
    }).addTo(map);

    let labeledLayers = []; 
    let overlayLayers = {};
    let layerPromises = []; 
    let boundaryLayer = null; 

    let tierGroups = { kecamatan: [], desa: [], poi: [] };

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
        return color;
    }

function onEachFeature(feature, layer) {
    if (feature.properties) {
        // 1. Logika Popup
        let popupContent = "<table>";
        let labelText = feature.properties.NAMA_DESA || feature.properties.NAMA || layer.options.layerName || "";
        let isAreaLayer = (layer.options.layerName !== 'Balai Desa' && layer.options.layerName !== 'Kecamatan Banyumas');

        for (let key in feature.properties) {
            if (feature.properties[key] && !['fid', 'id', 'Id', 'layer'].includes(key.toLowerCase())) { 
                let labelKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                popupContent += `<tr><td><b>${labelKey}:</b></td><td>${feature.properties[key]}</td></tr>`;
            }
        }
        layer.bindPopup(popupContent + "</table>");

        // 2. Logika Label/Tooltip (Pastikan ini TIDAK terhapus)
        if (labelText) {
            layer.bindTooltip(labelText, {
                permanent: true, 
                direction: isAreaLayer ? 'center' : 'auto', 
                className: 'custom-permanent-label'
            });
            labeledLayers.push({ layer: layer, isArea: isAreaLayer });
        }

        // 3. Logika Interaktif Khusus Lapisan DESA (Kelap-kelip per desa)
        if (isAreaLayer) {
            // Simpan warna asli desa
            layer.options.originalColor = layer.options.color;

            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({ weight: 4, color: '#ffffff', fillOpacity: 0.7 });
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        l.bringToFront();
                    }
                },
                mouseout: function (e) {
                    var l = e.target;
                    // Hanya reset gaya jika tidak sedang kelap-kelip
                    if (!l._path.classList.contains('flash-animation')) {
                        l.setStyle({
                            weight: 2,
                            color: l.options.originalColor,
                            fillOpacity: 0.3
                        });
                    }
                },
                click: function (e) {
                    var l = e.target;

                    // Hapus animasi dari desa lain
                    document.querySelectorAll('.flash-animation').forEach(el => {
                        el.classList.remove('flash-animation');
                    });

                    // Tambahkan animasi kelap-kelip ke desa yang dipilih
                    l._path.classList.add('flash-animation');

                    // Zoom ke lokasi desa
                    map.fitBounds(l.getBounds());
                    
                    // Matikan kelap-kelip otomatis setelah 3 detik
                    setTimeout(function() {
                        l._path.classList.remove('flash-animation');
                        l.setStyle({ weight: 2, color: l.options.originalColor, fillOpacity: 0.3 });
                    }, 3000);
                }
            });
        }
    }
}

    function loadGeoJSONLayer(fileName, layerName, styleOptions, pointToLayerFunc, tier, legendIconHtml = "") {
        const promise = fetch(fileName)
            .then(res => res.json())
            .then(data => {
                const lyr = L.geoJSON(data, {
                    style: styleOptions,
                    pointToLayer: pointToLayerFunc,
                    onEachFeature: onEachFeature,
                    layerName: layerName
                });

                if (tier === 'kecamatan') {
                    tierGroups.kecamatan.push(lyr);
                    boundaryLayer = lyr;
                } else if (tier === 'desa') {
                    tierGroups.desa.push(lyr);
                } else if (tier === 'poi') {
                    tierGroups.poi.push(lyr);
                }

                const labelWithIcon = `<span class="legend-icon">${legendIconHtml}</span> ${layerName}`;
                overlayLayers[labelWithIcon] = lyr;
                return lyr;
            }).catch(err => console.error(`Gagal: ${fileName}`, err));
        layerPromises.push(promise);
    }

    const namaDesa = ["Pekunden", "kedunguter", "sudagaran", "papringan", "kalisube", "Binangun", "Karangrau", "Danaraja", "Dawuhan", "pasinggangan", "Kejawar", "kedunggede"];
    namaDesa.forEach(desa => {
        const color = getRandomColor();
        const icon = `<span class="box-color" style="background-color:${color}; opacity:0.5;"></span>`;
        loadGeoJSONLayer(`${desa.toLowerCase()}.geojson`, desa, { color: color, weight: 2, fillOpacity: 0.3 }, null, 'desa', icon);
    });

    loadGeoJSONLayer('kecamatan_banyumas.geojson', 'Kecamatan Banyumas', { color: 'red', weight: 5, fillOpacity: 0.05, fillColor: 'red', dashArray: '10, 5' }, null, 'kecamatan', '<span class="line-dashed"></span>');

    const balaiMarker = (f, ll) => L.marker(ll, { 
        icon: L.divIcon({ className: 'balai-desa-icon', html: `<i class="fas fa-landmark" style="color: blue;"></i>` }) 
    });
    loadGeoJSONLayer('balai_desaa.geojson', 'Balai Desa', {}, balaiMarker, 'poi', '<i class="fas fa-landmark" style="color: blue;"></i>');

    function updateVisibility() {
        const zoom = map.getZoom();
        tierGroups.kecamatan.forEach(l => { if (!map.hasLayer(l)) l.addTo(map); });
        tierGroups.desa.forEach(l => {
            if (zoom >= 12) { if (!map.hasLayer(l)) l.addTo(map); } 
            else { if (map.hasLayer(l)) map.removeLayer(l); }
        });
        tierGroups.poi.forEach(l => {
            if (zoom >= 14) { if (!map.hasLayer(l)) l.addTo(map); } 
            else { if (map.hasLayer(l)) map.removeLayer(l); }
        });
    }

    Promise.all(layerPromises).then(() => {
        L.control.layers({ "Satelit": satellite, "Peta": osm }, overlayLayers, { collapsed: true, position: 'topright' }).addTo(map);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.locate({ position: 'topleft' }).addTo(map);
        
        const allFeatures = L.featureGroup(Object.values(overlayLayers));
        L.control.search({
            layer: allFeatures, propertyName: 'NAMA_DESA', initial: false, zoom: 15,
            marker: { icon: L.divIcon({ className: 'search-marker-icon', html: '<i class="fas fa-map-marker-alt" style="color: red; font-size: 30px;"></i>' }) },
            textPlaceholder: 'Cari...', position: 'topleft' 
        }).addTo(map);

        if (boundaryLayer) map.fitBounds(boundaryLayer.getBounds());
        map.on('zoomend', updateVisibility);
        updateVisibility(); 
    });
    </script>
</body>
</html>
